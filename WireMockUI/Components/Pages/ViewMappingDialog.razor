@using WireMock.Admin.Mappings
@using System.Text.Json

<MudDialog>
    <DialogContent>
        <MudGrid>
            <MudItem xs="12">
                <MudText Typo="Typo.h6">Mapping Details</MudText>
            </MudItem>

            <MudItem xs="12" md="8">
                <MudTextField Label="Title"
                              Value="@Mapping?.Title"
                              Variant="Variant.Outlined"
                              ReadOnly="true"
                              Margin="Margin.Dense" />
            </MudItem>

            <MudItem xs="12" md="4">
                <MudTextField Label="Priority"
                              Value="@Mapping?.Priority.ToString()"
                              Variant="Variant.Outlined"
                              ReadOnly="true"
                              Margin="Margin.Dense" />
            </MudItem>

            <MudItem xs="12">
                <MudDivider Class="my-2" />
                <MudText Typo="Typo.h6">Request Pattern</MudText>
            </MudItem>

            <MudItem xs="12" md="6">
                <MudTextField Label="Path"
                              Value="@(Mapping?.Request?.Path?.Matchers?.FirstOrDefault()?.Pattern ?? Mapping?.Request?.Path?.ToString() ?? "")"
                              Variant="Variant.Outlined"
                              ReadOnly="true"
                              Margin="Margin.Dense" />
            </MudItem>

            <MudItem xs="12" md="6">
                <MudTextField Label="Methods"
                              Value="@(Mapping?.Request?.Methods != null ? string.Join(", ", Mapping.Request.Methods) : "ANY")"
                              Variant="Variant.Outlined"
                              ReadOnly="true"
                              Margin="Margin.Dense" />
            </MudItem>

            @if (Mapping?.Request?.Headers != null && Mapping.Request.Headers.Any())
            {
                <MudItem xs="12">
                    <MudText Typo="Typo.subtitle2" Class="mt-2">Request Headers</MudText>
                    <MudPaper Class="pa-2 mt-2" Outlined="true">
                        @foreach (var header in Mapping.Request.Headers)
                        {
                            <MudText Typo="Typo.body2">
                                <strong>@header.Key:</strong> @JsonSerializer.Serialize(header.Value)
                            </MudText>
                        }
                    </MudPaper>
                </MudItem>
            }

            <MudItem xs="12">
                <MudDivider Class="my-2" />
                <MudText Typo="Typo.h6">Response</MudText>
            </MudItem>

            <MudItem xs="12" md="6">
                <MudTextField Label="Status Code"
                              Value="@Mapping?.Response?.StatusCode.ToString()"
                              Variant="Variant.Outlined"
                              ReadOnly="true"
                              Margin="Margin.Dense" />
            </MudItem>

            <MudItem xs="12" md="6">
                <MudTextField Label="Delay (ms)"
                              Value="@Mapping?.Response?.Delay?.ToString()"
                              Variant="Variant.Outlined"
                              ReadOnly="true"
                              Margin="Margin.Dense" />
            </MudItem>

            @if (Mapping?.Response?.Headers != null && Mapping.Response.Headers.Any())
            {
                <MudItem xs="12">
                    <MudText Typo="Typo.subtitle2" Class="mt-2">Response Headers</MudText>
                    <MudPaper Class="pa-2 mt-2" Outlined="true">
                        @foreach (var header in Mapping.Response.Headers)
                        {
                            <MudText Typo="Typo.body2">
                                <strong>@header.Key:</strong> @header.Value
                            </MudText>
                        }
                    </MudPaper>
                </MudItem>
            }

            @if (!string.IsNullOrWhiteSpace(Mapping?.Response?.Body))
            {
                <MudItem xs="12">
                    <MudText Typo="Typo.subtitle2" Class="mt-2">Response Body</MudText>
                    <MudPaper Class="pa-2 mt-2" Outlined="true">
                        <MudText Typo="Typo.body2" Style="font-family: monospace; white-space: pre-wrap;">@FormatBody(Mapping.Response.Body)</MudText>
                    </MudPaper>
                </MudItem>
            }
        </MudGrid>
    </DialogContent>
    <DialogActions>
        <MudButton Color="Color.Primary" OnClick="Close">Close</MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter]
    IMudDialogInstance? MudDialog { get; set; }

    [Parameter]
    public MappingModel? Mapping { get; set; }

    private void Close()
    {
        MudDialog?.Close();
    }

    private string FormatBody(string body)
    {
        try
        {
            var json = JsonSerializer.Deserialize<object>(body);
            return JsonSerializer.Serialize(json, new JsonSerializerOptions { WriteIndented = true });
        }
        catch
        {
            return body;
        }
    }
}
